<!DOCTYPE html> 
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Tech-AI Assistent</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #141b2d, #050814);
      color: #f6f7fb;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    a { color: #61dafb; }

    /* Layout */
    .app {
      display: grid;
      grid-template-columns: 260px 1fr 260px;
      grid-template-rows: auto 1fr auto;
      height: 100vh;
      max-width: 1600px;
      margin: 0 auto;
    }
    header {
      grid-column: 1 / 4;
      padding: 10px 18px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    header .title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      letter-spacing: 0.03em;
    }
    header .logo {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: linear-gradient(135deg, #3b82f6, #22c55e);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    header select, header button {
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.5);
      color: #e5e7eb;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 13px;
    }
    header button {
      background: linear-gradient(90deg, #3b82f6, #22c55e);
      border: none;
      font-weight: 600;
      color: #0b1220;
    }

    /* Seitenleisten */
    .sidebar-left,
    .sidebar-right {
      padding: 14px 14px 12px;
      border-right: 1px solid rgba(255,255,255,0.04);
    }
    .sidebar-right {
      border-right: none;
      border-left: 1px solid rgba(255,255,255,0.04);
    }
    .panel {
      border-radius: 16px;
      background: radial-gradient(circle at top, rgba(15,23,42,0.9), rgba(15,23,42,0.7));
      border: 1px solid rgba(148,163,184,0.35);
      padding: 12px 12px 10px;
      margin-bottom: 10px;
    }
    .panel h3 {
      font-size: 13px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .panel p, .panel li, .panel span {
      font-size: 12px;
      color: #cbd5f5;
    }
    .price {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .small-muted {
      font-size: 11px;
      opacity: 0.8;
      margin-top: 4px;
    }
    .btn-small {
      margin-top: 8px;
      width: 100%;
      padding: 6px 10px;
      border-radius: 999px;
      border: none;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(90deg, #3b82f6, #22c55e);
      color: #0b1220;
    }
    .btn-outline {
      background: transparent;
      border: 1px solid rgba(148,163,184,0.7);
      color: #e5e7eb;
    }

    /* Chatbereich */
    main {
      padding: 14px 12px 8px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #chat {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      margin-bottom: 10px;
    }
    .system-banner {
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(15,23,42,0.9);
      border: 1px dashed rgba(148,163,184,0.7);
      margin-bottom: 10px;
    }
    .msg {
      max-width: 80%;
      padding: 8px 10px;
      margin-bottom: 6px;
      border-radius: 14px;
      font-size: 13px;
      line-height: 1.4;
      white-space: pre-wrap;
    }
    .msg-user {
      margin-left: auto;
      background: linear-gradient(90deg, #3b82f6, #22c55e);
      color: #020617;
      border-bottom-right-radius: 4px;
    }
    .msg-ai {
      margin-right: auto;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(148,163,184,0.5);
      border-bottom-left-radius: 4px;
    }
    .msg-meta {
      font-size: 11px;
      opacity: 0.75;
      margin-bottom: 6px;
    }
    .sources {
      margin-top: 6px;
      border-left: 2px solid rgba(94,234,212,0.8);
      padding-left: 8px;
      font-size: 11px;
      opacity: 0.9;
    }

    /* Eingabe */
    .input-bar {
      grid-column: 1 / 4;
      border-top: 1px solid rgba(255,255,255,0.08);
      padding: 8px 12px;
      display: flex;
      align-items: flex-end;
      gap: 8px;
      background: radial-gradient(circle at top, #020617, #020617);
    }
    .input-wrapper {
      flex: 1;
      background: rgba(15,23,42,0.95);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.7);
      padding: 6px 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    textarea {
      width: 100%;
      border: none;
      background: transparent;
      color: #e5e7eb;
      resize: none;
      max-height: 80px;
      min-height: 36px;
      font-size: 13px;
      outline: none;
    }
    .input-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: #9ca3af;
    }
    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }
    .toggle input {
      accent-color: #22c55e;
    }
    .send-btn {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      font-weight: 600;
      background: linear-gradient(90deg, #3b82f6, #22c55e);
      color: #020617;
      cursor: pointer;
    }
    .send-btn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    /* Zusatzstyle: sekund√§rer Button f√ºr Sprachchat */
    .send-btn-ghost {
      padding: 5px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      font-size: 11px;
      font-weight: 500;
      background: transparent;
      color: #e5e7eb;
      cursor: pointer;
    }
    .send-btn-ghost.active {
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.4);
    }
    .voice-status {
      font-size: 10px;
      color: #9ca3af;
      text-align: center;
      margin-top: 2px;
    }

    /* Sessions rechts */
    .session-list {
      max-height: calc(100vh - 120px);
      overflow-y: auto;
      padding-right: 2px;
    }
    .session-item {
      padding: 6px 8px;
      border-radius: 10px;
      font-size: 12px;
      margin-bottom: 4px;
      cursor: pointer;
      border: 1px solid transparent;
    }
    .session-item.active {
      background: rgba(56,189,248,0.15);
      border-color: rgba(56,189,248,0.7);
    }
    .session-item span {
      display: block;
      font-size: 11px;
      opacity: 0.8;
      margin-top: 2px;
    }

    @media (max-width: 1100px) {
      .app {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto 1fr auto;
      }
      .sidebar-left, .sidebar-right {
        display: none;
      }
      header { grid-column: 1 / 2; }
      main { grid-column: 1 / 2; }
      .input-bar { grid-column: 1 / 2; }
    }

    /* ===== AUTH OVERLAY ===== */
    .auth-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .auth-card {
      background: #050b12;
      border-radius: 18px;
      padding: 24px 28px 28px;
      width: min(520px, 90vw);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.7);
      border: 1px solid #1f2937;
      color: #f9fafb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .auth-title {
      margin: 0;
      font-size: 26px;
      font-weight: 700;
    }
    .auth-subtitle {
      margin: 4px 0 16px;
      font-size: 13px;
      color: #9ca3af;
    }
    .auth-heading {
      margin: 8px 0 8px;
      font-size: 18px;
    }
    .auth-text {
      font-size: 13px;
      color: #d1d5db;
      margin-bottom: 10px;
    }
    .auth-small {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 8px;
    }
    .auth-label {
      display: block;
      font-size: 12px;
      margin-top: 8px;
      margin-bottom: 4px;
    }
    .auth-input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #374151;
      background: #020617;
      color: #f9fafb;
      font-size: 13px;
    }
    .auth-input:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px #38bdf8;
    }
    .auth-btn {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.05s ease;
    }
    .auth-btn-primary {
      background: linear-gradient(to right, #22c55e, #06b6d4);
      color: #0b1120;
      font-weight: 600;
    }
    .auth-btn-secondary {
      background: #0f172a;
      color: #e5e7eb;
      border: 1px solid #1f2937;
      margin-top: 8px;
    }
    .auth-btn-ghost {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid #374151;
    }
    .auth-btn:hover {
      transform: translateY(-1px);
    }
    .auth-btn-full {
      width: 100%;
      margin-top: 10px;
    }
    .auth-step {
      margin-top: 8px;
    }
    .auth-hidden {
      display: none;
    }
    .auth-mail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin: 8px 0 12px;
    }
    .auth-mail-btn {
      background: #020617;
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 8px;
      text-align: left;
    }
    .auth-mail-btn a {
      color: #e5e7eb;
      text-decoration: none;
      font-size: 13px;
    }
    .auth-mail-btn:hover {
      border-color: #38bdf8;
    }
    .auth-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    .auth-hint {
      font-size: 12px;
      color: #22c55e;
      margin-top: 6px;
    }
    .auth-error {
      font-size: 12px;
      color: #f97373;
      margin-top: 8px;
    }
    .user-label {
      font-size: 12px;
      color: #9ca3af;
      margin-left: 12px;
    }
  </style>
</head>
<body>

  <!-- LOGIN / REGISTRIERUNG OVERLAY -->
  <div id="auth-overlay" class="auth-overlay">
    <div class="auth-card">
      <h1 class="auth-title">Tech-AI</h1>
      <p class="auth-subtitle">Ihr ruhiger Technik-Helfer ‚Äì Schritt f√ºr Schritt.</p>

      <!-- Step 0: Auswahl -->
      <div id="auth-step-choose" class="auth-step">
        <h2 class="auth-heading">Bitte w√§hlen Sie aus.</h2>
        <button id="auth-btn-has-account" class="auth-btn auth-btn-primary">
          Ja, ich habe bereits ein Konto.
        </button>
        <button id="auth-btn-new-account" class="auth-btn auth-btn-secondary">
          Nein, ich m√∂chte ein neues Konto erstellen.
        </button>
      </div>

      <!-- Step 1: Registrierung -->
      <div id="auth-step-register" class="auth-step auth-hidden">
        <h2 class="auth-heading">Neues Konto erstellen</h2>
        <p class="auth-text">
          Wir finden zuerst Ihre E-Mail-Adresse. Klicken Sie auf die App, die Ihnen vertraut ist.
        </p>

        <div class="auth-mail-grid">
          <button class="auth-mail-btn">
            <a href="https://mail.google.com" target="_blank">Gmail (Android / Web)</a>
          </button>
          <button class="auth-mail-btn">
            <a href="https://www.icloud.com/mail" target="_blank">iCloud / Mail (iPhone)</a>
          </button>
          <button class="auth-mail-btn">
            <a href="https://outlook.live.com" target="_blank">Outlook / Hotmail</a>
          </button>
          <button class="auth-mail-btn">
            <a href="https://accounts.google.com/SignUp" target="_blank">Neue Gmail erstellen</a>
          </button>
        </div>

        <p class="auth-text">
          √ñffnen Sie dort Ihr Postfach. Oben auf Ihrem Profil-Bild oder Ihren Initialen sehen Sie Ihre E-Mail-Adresse.
          Tragen Sie diese Adresse hier ein:
        </p>

        <label class="auth-label">E-Mail-Adresse</label>
        <input id="auth-reg-email" class="auth-input" type="email" placeholder="z. B. max.mustermann@gmail.com">

        <label class="auth-label">Passwort (nur f√ºr dieses Demo-Konto)</label>
        <input id="auth-reg-pass" class="auth-input" type="password" placeholder="Passwort, das Sie sich merken k√∂nnen">

        <button id="auth-btn-send-code" class="auth-btn auth-btn-primary auth-btn-full">
          Best√§tigungscode anfordern
        </button>

        <p id="auth-code-info" class="auth-hint"></p>

        <label class="auth-label">Best√§tigungscode</label>
        <input id="auth-reg-code" class="auth-input" type="text" placeholder="6-stelliger Code">

        <div class="auth-actions">
          <button id="auth-btn-complete-register" class="auth-btn auth-btn-primary">
            Konto erstellen
          </button>
          <button id="auth-btn-back-from-register" class="auth-btn auth-btn-ghost">
            Zur√ºck
          </button>
        </div>

        <p class="auth-small">
          Hinweis: In der echten Version w√ºrden Sie den Code per E-Mail bekommen.
          In dieser Demo wird der Code hier im Fenster angezeigt.
        </p>

        <p id="auth-register-error" class="auth-error"></p>
      </div>

      <!-- Step 2: Login -->
      <div id="auth-step-login" class="auth-step auth-hidden">
        <h2 class="auth-heading">Anmeldung</h2>
        <p class="auth-text">
          Bitte geben Sie Ihre E-Mail-Adresse und Ihr Passwort ein, das Sie bei der Registrierung f√ºr Tech-AI gew√§hlt haben.
        </p>

        <label class="auth-label">E-Mail-Adresse</label>
        <input id="auth-login-email" class="auth-input" type="email" placeholder="Ihre E-Mail-Adresse">

        <label class="auth-label">Passwort</label>
        <input id="auth-login-pass" class="auth-input" type="password" placeholder="Passwort">

        <div class="auth-actions">
          <button id="auth-btn-login" class="auth-btn auth-btn-primary">
            Weiter
          </button>
          <button id="auth-btn-back-from-login" class="auth-btn auth-btn-ghost">
            Zur√ºck
          </button>
        </div>

        <p class="auth-small">
          Falls Sie Ihr Passwort in einer Notizen-App gespeichert haben, √∂ffnen Sie diese kurz und schauen dort nach.
        </p>

        <p id="auth-login-error" class="auth-error"></p>
      </div>
    </div>
  </div>

  <div class="app">
    <header>
      <div class="title">
        <div class="logo">T</div>
        <div>
          <div>Tech-AI</div>
          <small style="font-size:11px; opacity:0.8;">Dein ruhiger Technik-Helfer ‚Äì Schritt f√ºr Schritt.</small>
        </div>
      </div>

      <div style="display:flex; gap:8px; align-items:center;">
        <label style="font-size:12px;">
          Modus:
          <select id="mode-select">
            <option value="unerfahren">Unerfahren (sehr einfach)</option>
            <option value="erfahren">Erfahren</option>
          </select>
        </label>
        <span id="user-label" class="user-label">Gast (nicht eingeloggt)</span>
        <button id="new-topic-btn">Neues Problem</button>
      </div>
    </header>

    <!-- Linke Sidebar: Abo + Hinweise -->
    <aside class="sidebar-left">
      <div class="panel">
        <h3>Flex-Abo ‚Äì t√§glich k√ºndbar</h3>
        <div class="price">0,24 ‚Ç¨ / Tag</div>
        <p>Unbegrenzte Fragen zu allen Technik-Themen. Jederzeit k√ºndbar.</p>
        <button class="btn-small">Flex-Abo aktivieren</button>
        <p class="small-muted">In dieser lokalen Demo ist das Abo nur ein Platzhalter. Die Hilfe bleibt kostenlos.</p>
      </div>

      <div class="panel">
        <h3>Spar-Abo ‚Äì alle 2 Monate</h3>
        <div class="price">2,99 ‚Ç¨ / 2 Monate</div>
        <p>Ideal, wenn du Tech-AI regelm√§√üig nutzen m√∂chtest.</p>
        <button class="btn-small btn-outline">Spar-Abo aktivieren</button>
      </div>

      <div class="panel">
        <h3>Spende</h3>
        <p>Du kannst einen beliebigen Betrag zwischen 0,01 ‚Ç¨ und 10,00 ‚Ç¨ w√§hlen. Nur, wenn du wirklich zufrieden bist.</p>
        <button class="btn-small btn-outline">Jetzt spenden</button>
      </div>

      <div class="panel">
        <h3>Kostenlose Zeit</h3>
        <p>Eine Technik-Sitzung pro Thema. Wenn das Problem gel√∂st ist, fragt dich Tech-AI nach einem kleinen Abo f√ºr neue Themen.</p>
        <p class="small-muted">Kulanz: Auch nach 25 Antworten wird dieses Thema freundlich zu Ende betreut.</p>
      </div>

      <div class="panel">
        <h3>Tech-Tipps Datei</h3>
        <p>Eigene Verk√§ufer-Notizen kannst du in <code>tech-tips.txt</code> im Projektordner speichern.</p>
        <p class="small-muted">Form: Einfach Zeilen mit <code>- Tipp ...</code>. Die KI liest diese Tipps automatisch mit.</p>
      </div>
    </aside>

    <!-- Hauptbereich -->
    <main>
      <div class="system-banner" id="system-banner">
        Willkommen bei <strong>Tech-AI</strong> üòä Beschreibe dein Technik-Problem so, als w√ºrdest du es einem Verk√§ufer im Laden erkl√§ren.
      </div>
      <div id="chat"></div>
    </main>

    <!-- Rechte Sidebar: Sessions -->
    <aside class="sidebar-right">
      <div class="panel">
        <h3>
          Aktuelles Thema
          <button id="mark-solved-btn" class="btn-small btn-outline" style="width:auto; padding:4px 10px; font-size:11px;">
            Problem gel√∂st
          </button>
        </h3>
        <p id="current-topic-label" style="font-size:12px; margin-top:4px;">
          Noch kein Problem beschrieben. Starte unten mit deiner ersten Frage.
        </p>
      </div>

      <div class="panel">
        <h3>Gespeicherte Themen</h3>
        <div class="session-list" id="session-list"></div>
        <p class="small-muted">
          Hier siehst du fr√ºhere Themen von diesem Browser (lokal gespeichert).
        </p>
      </div>
    </aside>

    <!-- Eingabebereich -->
    <div class="input-bar">
      <div class="input-wrapper">
        <textarea id="message-input" placeholder="Beschreibe dein Problem so einfach wie m√∂glich, z. B. 'Meine Bluetooth-Kopfh√∂rer werden nicht gefunden'..."></textarea>
        <div class="input-footer">
          <label class="toggle">
            <input type="checkbox" id="web-search-toggle" />
            <span>Websuche (Tests & Bewertungen) verwenden</span>
          </label>
          <span id="answer-counter">Antworten in diesem Thema: 0 / 25</span>
        </div>
      </div>

      <!-- Rechts: Senden + Sprachchat -->
      <div style="display:flex; flex-direction:column; gap:4px; align-items:flex-end;">
        <button id="send-btn" class="send-btn">Senden</button>
        <button id="voice-btn" class="send-btn-ghost">üé§ Sprachchat</button>
        <div id="voice-status" class="voice-status">Sprachchat: aus</div>
      </div>
    </div>
  </div>

  <script>
    // ===== AUTH / LOGIN LOGIK =====
    let authCurrentUser = null;
    let authPendingCode = null;

    function updateUserLabel() {
      const label = document.getElementById("user-label");
      if (!label) return;

      if (authCurrentUser && authCurrentUser.email) {
        label.textContent = `Angemeldet als ${authCurrentUser.email}`;
      } else {
        label.textContent = "Gast (nicht eingeloggt)";
      }
    }

    function showAuthOverlay() {
      const overlay = document.getElementById("auth-overlay");
      if (overlay) overlay.style.display = "flex";
    }

    function hideAuthOverlay() {
      const overlay = document.getElementById("auth-overlay");
      if (overlay) overlay.style.display = "none";
    }

    function showAuthStep(stepId) {
      const steps = document.querySelectorAll(".auth-step");
      steps.forEach((s) => s.classList.add("auth-hidden"));
      const step = document.getElementById(stepId);
      if (step) step.classList.remove("auth-hidden");

      const err1 = document.getElementById("auth-register-error");
      const err2 = document.getElementById("auth-login-error");
      const info = document.getElementById("auth-code-info");
      if (err1) err1.textContent = "";
      if (err2) err2.textContent = "";
      if (info && stepId !== "auth-step-register") info.textContent = "";
    }

    function generateAuthCode() {
      authPendingCode = String(Math.floor(100000 + Math.random() * 900000));
      const info = document.getElementById("auth-code-info");
      if (info) {
        info.textContent =
          "In der echten Version w√ºrden Sie diesen Code per E-Mail bekommen. Test-Code: " +
          authPendingCode;
      }
    }

    function completeRegister() {
      const emailInput = document.getElementById("auth-reg-email");
      const passInput = document.getElementById("auth-reg-pass");
      const codeInput = document.getElementById("auth-reg-code");
      const errorBox = document.getElementById("auth-register-error");

      const email = emailInput.value.trim();
      const pass = passInput.value;
      const code = codeInput.value.trim();

      if (!email || !pass) {
        errorBox.textContent = "Bitte E-Mail-Adresse und Passwort eingeben.";
        return;
      }

      if (!authPendingCode) {
        errorBox.textContent = "Bitte zuerst einen Best√§tigungscode anfordern.";
        return;
      }

      if (code !== authPendingCode) {
        errorBox.textContent = "Der Best√§tigungscode ist falsch.";
        return;
      }

      const user = { email, password: pass };
      localStorage.setItem("techAiUser", JSON.stringify(user));
      authCurrentUser = user;
      updateUserLabel();
      hideAuthOverlay();
    }

    function loginExisting() {
      const emailInput = document.getElementById("auth-login-email");
      const passInput = document.getElementById("auth-login-pass");
      const errorBox = document.getElementById("auth-login-error");

      const email = emailInput.value.trim();
      const pass = passInput.value;

      const stored = localStorage.getItem("techAiUser");
      if (!stored) {
        errorBox.textContent =
          "Es wurde noch kein Konto gespeichert. Bitte zuerst ein Konto erstellen.";
        return;
      }

      const user = JSON.parse(stored);
      if (user.email !== email || user.password !== pass) {
        errorBox.textContent = "E-Mail-Adresse oder Passwort stimmen nicht.";
        return;
      }

      authCurrentUser = user;
      updateUserLabel();
      hideAuthOverlay();
    }

    function initAuth() {
      const hasAccountBtn = document.getElementById("auth-btn-has-account");
      const newAccountBtn = document.getElementById("auth-btn-new-account");
      const backFromRegBtn = document.getElementById("auth-btn-back-from-register");
      const backFromLoginBtn = document.getElementById("auth-btn-back-from-login");
      const sendCodeBtn = document.getElementById("auth-btn-send-code");
      const completeRegBtn = document.getElementById("auth-btn-complete-register");
      const loginBtn = document.getElementById("auth-btn-login");

      if (hasAccountBtn)
        hasAccountBtn.addEventListener("click", () => showAuthStep("auth-step-login"));
      if (newAccountBtn)
        newAccountBtn.addEventListener("click", () =>
          showAuthStep("auth-step-register")
        );
      if (backFromRegBtn)
        backFromRegBtn.addEventListener("click", () =>
          showAuthStep("auth-step-choose")
        );
      if (backFromLoginBtn)
        backFromLoginBtn.addEventListener("click", () =>
          showAuthStep("auth-step-choose")
        );
      if (sendCodeBtn) sendCodeBtn.addEventListener("click", generateAuthCode);
      if (completeRegBtn)
        completeRegBtn.addEventListener("click", completeRegister);
      if (loginBtn) loginBtn.addEventListener("click", loginExisting);

      const stored = localStorage.getItem("techAiUser");
      if (stored) {
        authCurrentUser = JSON.parse(stored);
        updateUserLabel();
        hideAuthOverlay();
      } else {
        showAuthOverlay();
        showAuthStep("auth-step-choose");
      }
    }

    // ===== CHAT + SPRACHCHAT =====
    const chatEl = document.getElementById("chat");
    const inputEl = document.getElementById("message-input");
    const sendBtn = document.getElementById("send-btn");
    const modeSelect = document.getElementById("mode-select");
    const webToggle = document.getElementById("web-search-toggle");
    const answerCounterEl = document.getElementById("answer-counter");
    const newTopicBtn = document.getElementById("new-topic-btn");
    const markSolvedBtn = document.getElementById("mark-solved-btn");
    const currentTopicLabel = document.getElementById("current-topic-label");
    const sessionListEl = document.getElementById("session-list");
    const voiceBtn = document.getElementById("voice-btn");
    const voiceStatusEl = document.getElementById("voice-status");

    let currentSessionId = "session-" + Date.now();
    let answerCount = 0;
    let freeLimit = 25;
    let currentTopicTitle = "";

    // Sprachchat-Status
    let isVoiceModeActive = false;
    let didVoiceEnd = false;
    let voiceTimerId = null;
    const MAX_VOICE_MS = 8 * 60 * 1000; // 8 Minuten

    function updateVoiceStatus() {
      if (!voiceStatusEl) return;
      if (isVoiceModeActive) {
        voiceStatusEl.textContent = "Sprachchat: aktiv (max. 8 Minuten)";
      } else {
        voiceStatusEl.textContent = "Sprachchat: aus";
      }
      if (voiceBtn) {
        if (isVoiceModeActive) voiceBtn.classList.add("active");
        else voiceBtn.classList.remove("active");
      }
    }

    function startVoiceChat() {
      if (isVoiceModeActive) return;
      isVoiceModeActive = true;
      didVoiceEnd = false;
      if (voiceTimerId) clearTimeout(voiceTimerId);

      voiceTimerId = setTimeout(() => {
        isVoiceModeActive = false;
        didVoiceEnd = true;
        updateVoiceStatus();

        // Kurze Info direkt im Chat
        appendMessage(
          "Die Sprachhilfe war jetzt etwa 8 Minuten aktiv. Ohne Abo geht Sprachchat leider nicht l√§nger. Im normalen Chat helfe ich dir bei diesem Problem weiter, bis es wirklich gel√∂st ist.",
          "ai"
        );
      }, MAX_VOICE_MS);

      updateVoiceStatus();
      appendMessage(
        "Sprachmodus gestartet. In dieser Demo schreibst du noch, aber die Zeit-Logik f√ºr 8 Minuten ist schon aktiv.",
        "ai"
      );
    }

    function stopVoiceChat(manual = false) {
      if (!isVoiceModeActive && !manual) return;
      isVoiceModeActive = false;
      if (voiceTimerId) clearTimeout(voiceTimerId);
      updateVoiceStatus();
      if (manual) {
        appendMessage(
          "Sprachmodus beendet. Du kannst ganz normal weiter schreiben.",
          "ai"
        );
      }
    }

    if (voiceBtn) {
      voiceBtn.addEventListener("click", () => {
        if (!isVoiceModeActive) {
          startVoiceChat();
        } else {
          stopVoiceChat(true);
        }
      });
    }

    // ==== Session-Speicher (localStorage) ====
    function loadSessions() {
      try {
        return JSON.parse(localStorage.getItem("techAiSessions") || "[]");
      } catch {
        return [];
      }
    }

    function saveSessions(sessions) {
      localStorage.setItem("techAiSessions", JSON.stringify(sessions));
    }

    function renderSessions() {
      const sessions = loadSessions();
      sessionListEl.innerHTML = "";
      if (sessions.length === 0) {
        sessionListEl.innerHTML = "<p style='font-size:12px; opacity:0.8;'>Noch keine gespeicherten Themen.</p>";
        return;
      }
      sessions
        .slice()
        .reverse()
        .forEach((s) => {
          const div = document.createElement("div");
          div.className = "session-item" + (s.id === currentSessionId ? " active" : "");
          div.textContent = s.title || "Unbenanntes Thema";
          const span = document.createElement("span");
          span.textContent = new Date(s.createdAt).toLocaleString();
          div.appendChild(span);
          div.onclick = () => {
            currentSessionId = s.id;
            currentTopicTitle = s.title;
            currentTopicLabel.textContent = "Thema: " + (s.title || "Unbenannt");
            renderSessions();
          };
          sessionListEl.appendChild(div);
        });
    }

    renderSessions();
    updateAnswerCounter();
    initAuth();
    updateVoiceStatus();

    function updateAnswerCounter() {
      answerCounterEl.textContent = `Antworten in diesem Thema: ${answerCount} / ${freeLimit}`;
    }

    function appendMessage(text, from, extra = {}) {
      const wrapper = document.createElement("div");

      const meta = document.createElement("div");
      meta.className = "msg-meta";
      meta.textContent =
        (from === "user" ? "Du" : "Tech-AI") +
        " ¬∑ " +
        new Date().toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit" });
      wrapper.appendChild(meta);

      const msg = document.createElement("div");
      msg.className = "msg " + (from === "user" ? "msg-user" : "msg-ai");
      msg.textContent = text;
      wrapper.appendChild(msg);

      if (from === "ai" && extra.webResults && extra.webResults.length > 0) {
        const sourcesDiv = document.createElement("div");
        sourcesDiv.className = "sources";
        sourcesDiv.innerHTML =
          "<strong>Recherchierte Quellen:</strong><br>" +
          extra.webResults
            .map(
              (r) =>
                `[${r.index}] ${r.title}<br><a href="${r.link}" target="_blank">${r.link}</a>`
            )
            .join("<br><br>");
        wrapper.appendChild(sourcesDiv);
      }

      chatEl.appendChild(wrapper);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    async function sendMessage({ markSolved = false, explicitText = null, viaVoice = false } = {}) {
      const message = explicitText ?? inputEl.value.trim();
      if (!message) return;

      appendMessage(message, "user");
      if (!currentTopicTitle) {
        currentTopicTitle = message.slice(0, 60);
        currentTopicLabel.textContent = "Thema: " + currentTopicTitle;
        const sessions = loadSessions();
        sessions.push({
          id: currentSessionId,
          title: currentTopicTitle,
          createdAt: Date.now(),
        });
        saveSessions(sessions);
        renderSessions();
      }

      inputEl.value = "";
      sendBtn.disabled = true;

      try {
        const body = {
          mode: modeSelect.value === "erfahren" ? "erfahren" : "unerfahren",
          message,
          sessionId: currentSessionId,
          newTopic: false,
          markSolved,
          useWebSearch: webToggle.checked,
          topicTitle: currentTopicTitle,
          fromVoice: viaVoice || isVoiceModeActive,
          voiceSessionEnded: didVoiceEnd,
        };

        // Flag nur f√ºr diese eine Anfrage verwenden
        didVoiceEnd = false;

        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          appendMessage(
            "Es ist ein Fehler passiert: " + (err.error || res.statusText),
            "ai"
          );
        } else {
          const data = await res.json();
          answerCount = data.answerCount ?? answerCount;
          freeLimit = data.freeLimit ?? freeLimit;
          updateAnswerCounter();
          appendMessage(data.reply || "Keine Antwort erhalten.", "ai", {
            webResults: data.webResults || [],
          });
        }
      } catch (err) {
        console.error(err);
        appendMessage(
          "Es ist ein Netzwerkfehler passiert. Pr√ºfe bitte, ob der Server l√§uft (CMD: `node server.js`).",
          "ai"
        );
      } finally {
        sendBtn.disabled = false;
        inputEl.focus();
      }
    }

    sendBtn.addEventListener("click", () => sendMessage());
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    newTopicBtn.addEventListener("click", () => {
      currentSessionId = "session-" + Date.now();
      currentTopicTitle = "";
      currentTopicLabel.textContent =
        "Neues Thema gestartet. Beschreibe dein n√§chstes Problem.";
      answerCount = 0;
      updateAnswerCounter();
      chatEl.innerHTML = "";
      document.getElementById("system-banner").textContent =
        "Neues Problem gestartet. Beschreibe dein n√§chstes Thema bitte in einer Nachricht.";
      renderSessions();
    });

    markSolvedBtn.addEventListener("click", () => {
      if (!currentTopicTitle) return;
      sendMessage({ markSolved: true, explicitText: "Mein aktuelles Problem ist gel√∂st." });
    });
  </script>
</body>
</html>
